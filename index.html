<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Visor de Autorizaciones Vigentes</title>
  <style>
    :root{
      --bg:#eef3f9;
      --fg:#0f2653;
      --card:#ffffff;
      --muted:#6b7b8a;
      --border:#e0e6ef;
      --accent:#1f6fd6;
      --accent-2:#0e4aa1;
      --ok:#1f8b4c;
      --err:#c62828;
      --info:#1d4f8f;
      --shadow:0 2px 6px rgba(17,28,45,.12);
      --radius:14px;
      --row-alt:#f3f8ff;
      --table-zoom:1;
    }

    *{box-sizing:border-box}

    body{
      font-family:system-ui,Segoe UI,Arial,sans-serif;
      background:var(--bg);
      margin:0;
      padding:16px;
      color:var(--fg);
      font-size:14px;
    }

    h1{font-size:24px;margin:0 0 6px;letter-spacing:.4px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 16px;
      margin:0 auto 14px;
      max-width:1100px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .muted{color:var(--muted);font-size:13px}

    input,button{
      padding:10px 12px;
      border:1px solid #ccd6e0;
      border-radius:10px;
      font-size:14px;
      background:#fff;
    }

    input:focus{
      outline:2px solid rgba(31,111,214,.2);
      border-color:var(--accent);
    }

    button{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color:#fff;
      border:none;
      font-weight:600;
      letter-spacing:.2px;
      box-shadow:0 6px 16px rgba(31,111,214,.25);
      cursor:pointer;
    }
    button:hover{filter:brightness(1.03)}
    button:active{transform:translateY(1px)}
    button:disabled{
      opacity:.65;
      cursor:not-allowed;
      box-shadow:none;
    }

    .wrap{
      overflow:auto;
      max-height:70vh;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }

    table{
      border-collapse:collapse;
      width:100%;
      min-width:900px;
      background:#fff;
    }

    th,td{
      border-bottom:1px solid #eef2f6;
      padding:10px 12px;
      font-size:calc(14px * var(--table-zoom));
      text-align:left;
      white-space:nowrap;
    }

    th{
      position:sticky;
      top:0;
      background:#1f6fd6;
      color:#ffffff;
      z-index:1;
    }

    #wrap tbody tr:nth-child(even){background:var(--row-alt);}

    .pager{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:var(--muted);
      flex-wrap:wrap;
    }

    .pager button{
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
    }

    .pager button[disabled]{
      opacity:0.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    .pager-size,
    .pager-jump{
      display:flex;
      align-items:center;
      gap:4px;
    }

    .pager-jump input{
      width:60px;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #ccd6e0;
      font-size:13px;
    }

    #pageSizeSel,
    #pageJump{
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #ccd6e0;
      font-size:13px;
      background:#fff;
      color:var(--fg);
    }

    .brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .brand .logos{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      flex-wrap:nowrap;
    }
    .brand img{
      height:44px;
      object-fit:contain;
    }
    .subtitle{
      color:#3a4d67;
      font-size:13px;
      text-align:center;
    }

    .pill{
      display:inline-block;
      background:#eef5ff;
      border:1px solid #d6e6ff;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      color:#1d4f8f;
      font-weight:600;
    }

    #modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }

    #modal::before{
      content:"";
      position:absolute;
      inset:0;
      background:rgba(10,20,40,.45);
      backdrop-filter:blur(2px);
    }

    #modal.hidden{display:none}

    #modal .box{
      position:relative;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px 16px;
      max-width:520px;
      width:min(520px,95vw);
      box-shadow:0 16px 36px rgba(0,0,0,.25);
      animation:pop .18s ease-out;
    }

    @keyframes pop{
      from{transform:scale(.98);opacity:.7}
      to{transform:scale(1);opacity:1}
    }

    #modal h2{margin:0 0 6px;font-size:18px}
    #fileName{font-size:13px;color:#334e68}

    .soft{
      border:1px dashed #d3deea;
      background:#f8fbff;
      padding:10px;
      border-radius:12px;
    }

    .alert{
      margin-top:8px;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      text-align:center;  
    }

    .alert.info{background:#e8f3ff;border:1px solid #cfe6ff;color:#1d4f8f}
    .alert.ok{background:#e9f7ef;border:1px solid #c9ebd7;color:#176f3f}
    .alert.err{background:#fdeaea;border:1px solid #f5c2c0;color:#962323}

    .spinner{
      width:16px;
      height:16px;
      border:2px solid transparent;
      border-top-color:currentColor;
      border-right-color:currentColor;
      border-radius:50%;
      animation:spin .7s linear infinite;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    #splash{
      position:fixed;
      inset:0;
      z-index:10000;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 600px at 50% -10%, #ffffff 0%, #eef3f9 55%, #e3ebf7 100%);
      color:#0f2653;
    }

    #splash h1{
      margin:14px 0 0;
      font-size:28px;
      letter-spacing:.6px;
    }

    #splash img{
      max-width:min(60vw,520px);
      max-height:40vh;
      object-fit:contain;
      filter: drop-shadow(0 6px 24px rgba(0,0,0,.15));
    }

    #splash .copy{
      position:absolute;
      bottom:20px;
      font-size:12px;
      color:#3a4d67;
    }

    #splash.hide{
      opacity:0;
      transition:opacity .35s ease;
      pointer-events:none;
    }

    .footer{
      display:flex;
      align-items:center;
      justify-content:center;
      color:#3a4d67;
      font-size:13px;
    }

    #btnSettings{
      background:none;
      border:none;
      box-shadow:none;
      padding:0;
      margin-left:8px;
      color:#1f6fd6;
      text-decoration:underline;
      font:inherit;
      cursor:pointer;
    }

    #btnSettings:hover{
      filter:none;
      text-decoration:none;
    }

    body.dark{
      --bg:#0f1420;
      --card:#121a2b;
      --fg:#e8edf7;
      --muted:#a8b3c7;
      --border:#253049;
      --accent:#6aa2ff;
      --accent-2:#3d77d6;
      --shadow:0 8px 24px rgba(0,0,0,.45);
      --row-alt:#18243a;
    }

    body.dark table{background:#101726;}
    body.dark th{
      background:#0d47a1;
      color:#e8edf7;   
      border-bottom:1px solid var(--border);
    }
    body.dark td{border-bottom:1px solid var(--border);}
    body.dark .wrap{border-color:var(--border);}
    body.dark .card{background:var(--card);border-color:var(--border);}
    body.dark input, body.dark button{
      background:#0f1726;
      color:var(--fg);
      border-color:#2a3550;
    }
    body.dark input::placeholder{color:#7d8aa6;}
    body.dark #pageSizeSel,
    body.dark #pageJump{
      background:#0f1726;
      color:var(--fg);
      border-color:#2a3550;
    }

    .bold-table, .bold-table *{font-weight:700 !important;}

    .actions{
      display:flex;
      gap:8px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }

    .actions button{min-width:42px;}

    #wrap{overflow-x:auto;}
    #wrap table{min-width:1600px;}
    #wrap th:nth-child(2), #wrap td:nth-child(2){min-width:280px;}
    #wrap th:nth-child(4), #wrap td:nth-child(4){min-width:260px;}
    #wrap th:nth-child(13), #wrap td:nth-child(13){min-width:340px;}
    #wrap th:nth-child(12), #wrap td:nth-child(12){min-width:220px;}
  </style>
</head>
<body>

  <!-- SPLASH / INTRODUCCI√ìN -->
  <div id="splash">
    <img src="img/pen.png" alt="PEN" data-alticon="‚öì">
    <h1><strong>AUTORIZACIONES PEN</strong></h1>
    <div class="copy">¬© 2025 ‚Äî Autorizaciones PEN ‚Ä¢ Uso interno ‚öì</div>
  </div>

  <!-- 1) T√çTULO + SUBT√çTULO -->
  <div class="card">
    <div class="brand">
      <div class="logos">
        <img src="img/ancla.png" alt="Ancla" data-alticon="üî±">
        <h1 style="text-align: center;"><strong>AUTORIZACIONES PEN</strong></h1>
        <img src="img/bnpb.png" alt="BNPB" data-alticon="üî±">
      </div>
      <div class="subtitle">
        Visor de Autoriz. üìë cifrado AES-GCM üîê ‚Ä¢ Procesamiento local üåê
      </div>
    </div>
    <div id="meta" class="muted" style="margin-top:8px;text-align:center;"></div>
  </div>

  <!-- 2) BUSCADOR + CONTADOR + LIMPIAR -->
  <div class="card">
    <div class="row" style="flex-direction:column; gap:8px; align-items:stretch;">

      <div class="row" style="gap:8px; align-items:stretch;">
        <input id="q"
              placeholder="Buscar (DNI, Apellido, Nombre, N¬∞ Autoriz, Lugar, Responsable...)"
              style="flex:3 1 0; min-width:0;">
        <button id="clear"
                title="Limpiar b√∫squeda"
                style="flex:1 1 0; white-space:nowrap;">
          Limpiar
        </button>
      </div>

      <div class="row" style="justify-content:flex-start;">
        <span id="count" class="pill">0 resultados</span>
      </div>

    </div>
  </div>

  <!-- 3) LISTADO DE AUTORIZ.-->
  <div class="card">
    <div class="wrap" id="wrap"></div>
  </div>

  <!-- 4) NAVEGACI√ìN (PAGINADOR) -->
  <div class="card">
    <div id="pager" class="pager"></div>
  </div>

  <!-- 5) BOTONES MODO OSCURO / ZOOM / LINK (ID) DRIVE -->
  <div class="card">
    <div class="actions">
      <button id="btnTheme" title="Modo oscuro/claro">üåô Oscuro</button>
      <button id="btnBold" title="Negrita">ùêÅ Negrita</button>
      <button id="btnPlus" title="Aumentar tama√±o (A+)">A+</button>
      <button id="btnMinus" title="Reducir tama√±o (A-)">A-</button>
    </div>
  </div>

  <!-- 6) FOOTER -->
  <div class="card">
    <div class="footer">
      <span>¬© 2025 ‚Äî Autorizaciones PEN üõÉ ‚Ä¢ CC BNPB</span>
      <button id="btnSettings"
              title="Configurar enlace de Drive"
              style="display:none">
        ‚öôÔ∏è Drive
      </button>
    </div>
  </div>

  <!-- MODAL ARCHIVO / CLAVE -->
  <div id="modal">
    <div class="box">
      <h2>Seleccionar archivo de autorizaciones</h2>
      <div class="soft">
        <div class="row" style="width:100%; margin-bottom:8px; text-align: center;">
          <button id="pick" style="width:100%;">
            üìÇ Seleccionar archivo (.bin)
          </button>
        </div>

        <div class="row" style="width:100%;">
          <span id="fileName" class="muted" style="width:100%; word-break:break-all; ; text-align: center;">
            Ning√∫n archivo seleccionado
          </span>
        </div>
      </div>

      <div id="stepPw"
           class="row"
           style="display:none;flex-direction:column;align-items:stretch;gap:8px;margin-top:10px">
        <input type="password" id="pw" placeholder="Contrase√±a" autocomplete="off">
        <button id="openBtn" disabled>üîì Abrir</button>
        <div id="msg" class="alert info" style="display:none">
          <span style="text-align: center;" class="spinner"></span><span>Descifrando‚Ä¶</span>
        </div>
      </div>

      <input type="file" id="f" accept=".bin" style="display:none">
      <div class="muted" style="margin-top:8px; text-align: center;">
        El archivo se procesa localmente. No se env√≠a a internet.
      </div>
    </div>
  </div>

  <script>
    let PREFETCH_BUF = null;
    let PREFETCH_NAME = "";
    let DRIVE_AVAILABLE = false;

    const MAGIC = "APEN1";
    const VERSION = 1;

    let PAGE_SIZE = 50;
    const PAGE_SIZE_OPTIONS = [50, 100, 200, 300, 500];

    function b64ToArrayBuffer(b64) {
      const bin = atob(b64);
      const len = bin.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
      return bytes.buffer;
    }

    function installEmojiFallbacks() {
      document.querySelectorAll('img[data-alticon]').forEach(img => {
        function onErr() {
          img.removeEventListener('error', onErr);
          const emoji = img.getAttribute('data-alticon') || '‚ùì';
          const span = document.createElement('span');
          span.textContent = emoji;
          const rect = img.getBoundingClientRect();
          const h = rect.height || img.height || parseInt(getComputedStyle(img).height) || 40;
          span.style.fontSize = h + 'px';
          span.style.lineHeight = h + 'px';
          span.style.height = h + 'px';
          span.style.width = 'auto';
          span.style.verticalAlign = 'middle';
          img.replaceWith(span);
        }
        img.addEventListener('error', onErr, { once: true });
      });
    }

    const norm = s => (s || "").normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();

    async function pbkdf2Key(pass, salt, iter) {
      const enc = new TextEncoder();
      const baseKey = await crypto.subtle.importKey(
        "raw",
        enc.encode(pass),
        "PBKDF2",
        false,
        ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          hash: "SHA-256",
          salt,
          iterations: iter
        },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["decrypt"]
      );
    }

    async function decryptBin(buf, pass) {
      const magic = new TextDecoder().decode(new Uint8Array(buf.slice(0, 5)));
      if (magic !== MAGIC) throw new Error("Archivo inv√°lido (MAGIC).");

      const ver = new DataView(buf, 5, 1).getUint8(0);
      if (ver !== VERSION) throw new Error("Versi√≥n no soportada.");

      const salt = new Uint8Array(buf.slice(6, 22));
      const nonce = new Uint8Array(buf.slice(22, 34));
      const iters = new DataView(buf.slice(34, 38)).getUint32(0, false);
      const ct = new Uint8Array(buf.slice(38));

      const key = await pbkdf2Key(pass, salt, iters);
      const plain = await crypto.subtle.decrypt({ name: "AES-GCM", iv: nonce }, key, ct);
      const jsonStr = new TextDecoder().decode(new Uint8Array(plain));
      return JSON.parse(jsonStr);
    }

    const msgBox = document.getElementById("msg");
    const modal  = document.getElementById("modal");
    const pickBtn = document.getElementById("pick");
    const fileInp = document.getElementById("f");
    const fileLbl = document.getElementById("fileName");
    const stepPw  = document.getElementById("stepPw");
    const pwInp   = document.getElementById("pw");
    const openBtn = document.getElementById("openBtn");
    const metaEl  = document.getElementById("meta");
    const wrap    = document.getElementById("wrap");
    const pager   = document.getElementById("pager");
    const pill    = document.getElementById("count");
    const searchInput = document.getElementById("q");
    const pagerCard = pager ? pager.closest(".card") : null;

    function setAlert(type, text, withSpinner = false) {
      msgBox.className = "alert " + (type || "info");
      msgBox.style.display = "flex";

      const escText = String(text).replace(/[&<>\"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[m]));

      msgBox.innerHTML =
        (withSpinner ? '<span class="spinner"></span>' : '') +
        `<span>${escText}</span>`;
    }

    function hideAlert() {
      msgBox.style.display = "none";
    }

    function esc(s) {
      return String(s).replace(/[&<>\"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[m]));
    }

    function fmt(v) {
      const isEmpty = (v === null || v === undefined || v === "");
      return isEmpty ? "-" : esc(String(v));
    }

    function fmtPair(a, b) {
      const A = fmt(a), B = fmt(b), empty = "-";
      if (A === empty && B === empty) return empty;
      if (A === empty) return B;
      if (B === empty) return A;
      return `${A} ${B}`;
    }

    const FIELDS = [
      "dni","ap","nom","nac","observ","n_aut","lugar",
      "z_restr","z_res","f_ini","h_ini","f_fin","h_fin",
      "resp","mot","observ_s","dest","contacto","vinc"
    ];

    function normalizeRecord(r) {
      const out = {};
      for (const k of FIELDS) out[k] = (r && r[k] != null) ? r[k] : "";
      return out;
    }

    let DATA = [];
    let FILTERED = [];
    let CURRENT_PAGE = 1;

    function getTotalPages() {
      if (FILTERED.length === 0) return 1;
      return Math.max(1, Math.ceil(FILTERED.length / PAGE_SIZE));
    }

    function renderPager() {
      const totalPages = getTotalPages();
      if (!pager) return;

      if (totalPages <= 1) {
        pager.innerHTML = "";
        if (pagerCard) {
          pagerCard.style.display = "none";
        }
        return;
      }

      if (pagerCard) {
        pagerCard.style.display = "";
      }

      const optionsHtml = PAGE_SIZE_OPTIONS.map(size =>
        `<option value="${size}" ${size === PAGE_SIZE ? "selected" : ""}>${size}</option>`
      ).join("");

      pager.innerHTML = `
        <button data-action="first" ${CURRENT_PAGE === 1 ? "disabled" : ""}>&laquo;</button>
        <button data-action="prev"  ${CURRENT_PAGE === 1 ? "disabled" : ""}>Anterior</button>
        <span>P√°gina ${CURRENT_PAGE} de ${totalPages}</span>
        <button data-action="next" ${CURRENT_PAGE === totalPages ? "disabled" : ""}>Siguiente</button>
        <button data-action="last" ${CURRENT_PAGE === totalPages ? "disabled" : ""}>&raquo;</button>

        <label class="pager-size">
          Ver
          <select id="pageSizeSel">
            ${optionsHtml}
          </select>
          por p√°gina
        </label>

        <label class="pager-jump">
          Ir a p√°g.
          <input id="pageJump" type="number" min="1" max="${totalPages}" value="${CURRENT_PAGE}">
          <button data-action="jump">Ir</button>
        </label>
      `;
    }

    if (pager) {
      pager.addEventListener("click", e => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const action = btn.dataset.action;
        const totalPages = getTotalPages();

        if (action === "first") {
          if (CURRENT_PAGE === 1) return;
          CURRENT_PAGE = 1;
        } else if (action === "prev") {
          if (CURRENT_PAGE <= 1) return;
          CURRENT_PAGE--;
        } else if (action === "next") {
          if (CURRENT_PAGE >= totalPages) return;
          CURRENT_PAGE++;
        } else if (action === "last") {
          if (CURRENT_PAGE === totalPages) return;
          CURRENT_PAGE = totalPages;
        } else if (action === "jump") {
          const inp = pager.querySelector("#pageJump");
          if (!inp) return;
          let target = parseInt(inp.value, 10);
          if (isNaN(target)) return;
          if (target < 1) target = 1;
          if (target > totalPages) target = totalPages;
          CURRENT_PAGE = target;
        } else {
          return;
        }

        renderPage();
      });
    }

    if (pager) {
      pager.addEventListener("change", e => {
        const sel = e.target.closest("#pageSizeSel");
        if (!sel) return;

        const newSize = parseInt(sel.value, 10);
        if (!isNaN(newSize) && newSize > 0) {
          PAGE_SIZE = newSize;
          CURRENT_PAGE = 1;
          renderPage();
        }
      });
    }

    if (pager) {
      pager.addEventListener("keydown", e => {
        const inp = e.target.closest("#pageJump");
        if (!inp) return;
        if (e.key === "Enter") {
          e.preventDefault();
          const btnJump = pager.querySelector('button[data-action="jump"]');
          if (btnJump) btnJump.click();
        }
      });
    }

    function renderPage() {
      const total = FILTERED.length;
      const totalPages = getTotalPages();

      if (CURRENT_PAGE > totalPages) {
        CURRENT_PAGE = totalPages;
      }

      const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
      const end   = start + PAGE_SIZE;
      const pageItems = FILTERED.slice(start, end);

      if (total === 0) {
        pill.textContent = "0 resultados";
      } else if (total <= PAGE_SIZE) {
        pill.textContent = `${total} resultados`;
      } else {
        pill.textContent = `${total} resultados (mostrando ${PAGE_SIZE} por p√°gina)`;
      }

      const rows = pageItems.map(o => `
        <tr>
          <td>${fmt(o.dni)}</td>
          <td>${fmt(o.ap)}, ${fmt(o.nom)}</td>
          <td>${fmt(o.nac)}</td>
          <td>${fmt(o.observ)}</td>
          <td>${fmt(o.n_aut)}</td>
          <td>${fmt(o.lugar)}</td>
          <td>${fmt(o.z_restr)}</td>
          <td>${fmt(o.z_res)}</td>
          <td>${fmtPair(o.f_ini, o.h_ini)}</td>
          <td>${fmtPair(o.f_fin, o.h_fin)}</td>
          <td>${fmt(o.resp)}</td>
          <td>${fmt(o.mot)}</td>
          <td>${fmt(o.observ_s)}</td>
        </tr>
      `).join("");

      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>DNI</th>
              <th>Apellido y Nombre</th>
              <th>Nac.</th>
              <th>Observ.</th>
              <th>N¬∞ Autoriz.</th>
              <th>Lugar</th>
              <th>Z.Com√∫n</th>
              <th>Z.Reserv.</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Responsable</th>
              <th>Motivo/Empresa</th>
              <th>Observ Gral autoriz.</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      renderPager();
    }

    function applyFilter() {
      const q = norm(searchInput.value);
      if (!q) {
        FILTERED = DATA.slice();
      } else {
        FILTERED = DATA.filter(o => {
          const hay = [
            o.dni, o.ap, o.nom, o.n_aut, o.lugar,
            o.resp, o.mot, o.dest, o.contacto,
            o.z_restr, o.z_res, o.vinc, o.nac
          ].map(norm).join(" ");
          return hay.includes(q);
        });
      }
      CURRENT_PAGE = 1;
      renderPage();
    }

    function anyToDmyHM(s) {
      if (!s) return "?";
      const t = String(s).trim();

      const iso = t.match(
        /^(\d{4})[-\/.](\d{2})[-\/.](\d{2})(?:[T\s](\d{2}):(\d{2})(?::\d{2})?(?:\.\d+)?(?:Z|[+-]\d{2}:?\d{2})?)?$/
      );
      if (iso) {
        const [, y, mo, d, hh, mm] = iso;
        const fecha = `${d}/${mo}/${y}`;
        if (hh != null) {
          return `${fecha} ${hh}:${mm ?? "00"}`;
        }
        return fecha;
      }

      const dmy = t.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2}))?$/);
      if (dmy) {
        const [, d, mo, y, hh, mm] = dmy;
        return hh ? `${d}/${mo}/${y} ${hh}:${mm}` : `${d}/${mo}/${y}`;
      }

      return t;
    }

    pickBtn.addEventListener("click", () => fileInp.click());

    fileInp.addEventListener("change", () => {
      PREFETCH_BUF = null;
      PREFETCH_NAME = "";

      const f = fileInp.files[0];
      if (!f) {
        fileLbl.textContent = "Ning√∫n archivo seleccionado";
        stepPw.style.display = "none";
        openBtn.disabled = true;
        hideAlert();
        return;
      }

      fileLbl.textContent = `Archivo: ${f.name}`;
      stepPw.style.display = "flex";
      pwInp.focus();
      openBtn.disabled = false;
      hideAlert();
    });

    openBtn.addEventListener("click", async () => {
      const f  = fileInp.files[0];
      const pw = (pwInp.value || "").trim();

      if (!PREFETCH_BUF && !f) {
        setAlert("err", "Seleccion√° el Archivo .bin o Descargalo desde Drive.");
        return;
      }

      if (!pw) {
        setAlert("err", "Ingres√° la contrase√±a");
        return;
      }

      setAlert("info", "Descifrando‚Ä¶", true);

      try {
        const buf = PREFETCH_BUF || (await f.arrayBuffer());
        const obj = await decryptBin(buf, pw);

        DATA = (obj.data || []).map(normalizeRecord);
        FILTERED = DATA.slice();
        CURRENT_PAGE = 1;
        renderPage();

        const generado = anyToDmyHM(obj.meta?.generado);
        const total    = obj.meta?.total || DATA.length;
        metaEl.textContent = `Generado: ${generado} ‚Ä¢ Registros: ${total}`;
        applyFileIdInfo();

        setAlert("ok", "Listo: Datos cargados correctamente.");

        setTimeout(() => {
          modal.classList.add("hidden");
          hideAlert();
          pwInp.value = "";
        }, 450);
      } catch (e) {
        console.error(e);
        setAlert("err", "Error: clave incorrecta o archivo da√±ado.");
        pwInp.value = "";
        pwInp.focus();
      }
    });

    searchInput.oninput = () => {
      applyFilter();
    };

    document.getElementById("clear").onclick = () => {
      searchInput.value = "";
      applyFilter();
    };

    function hideSplash() {
      const s = document.getElementById('splash');
      if (!s) return;
      s.classList.add('hide');
      setTimeout(() => {
        s.style.display = 'none';
      }, 400);
    }

    (function () {
      const st = {
        theme: localStorage.getItem("vis_theme") || "light",
        bold : localStorage.getItem("vis_bold") === "1",
        zoom : parseFloat(localStorage.getItem("vis_zoom") || "1")
      };

      const btnTheme    = document.getElementById("btnTheme");
      const btnBold     = document.getElementById("btnBold");
      const btnPlus     = document.getElementById("btnPlus");
      const btnMinus    = document.getElementById("btnMinus");
      const btnSettings = document.getElementById("btnSettings");

      function apply() {
        document.body.classList.toggle("dark", st.theme === "dark");

        if (wrap) {
          wrap.classList.toggle("bold-table", st.bold === true);
        }

        if (isNaN(st.zoom)) st.zoom = 1;
        st.zoom = Math.min(1.6, Math.max(0.85, st.zoom));
        document.documentElement.style.setProperty("--table-zoom", st.zoom);

        if (btnTheme) {
          btnTheme.textContent = (st.theme === "dark" ? "‚òÄÔ∏è Claro" : "üåô Oscuro");
        }
        if (btnBold) {
          btnBold.textContent = (st.bold ? "ùêÅ Negrita: ON" : "ùêÅ Negrita");
        }
      }

      apply();

      btnTheme?.addEventListener("click", () => {
        st.theme = (st.theme === "dark" ? "light" : "dark");
        localStorage.setItem("vis_theme", st.theme);
        apply();
      });

      btnBold?.addEventListener("click", () => {
        st.bold = !st.bold;
        localStorage.setItem("vis_bold", st.bold ? "1" : "0");
        apply();
      });

      btnPlus?.addEventListener("click", () => {
        st.zoom += 0.05;
        localStorage.setItem("vis_zoom", String(st.zoom));
        apply();
      });

      btnMinus?.addEventListener("click", () => {
        st.zoom -= 0.05;
        localStorage.setItem("vis_zoom", String(st.zoom));
        apply();
      });

      if (btnSettings && window.Android && typeof Android.openSettings === "function") {
        btnSettings.style.display = "inline-block";
        btnSettings.addEventListener("click", () => {
          Android.openSettings();
        });
      }
    })();

    async function onRemoteReady() {
      try {
        if (!window.Android || typeof Android.hasRemoteBin !== "function") {
          return;
        }

        const hay = !!Android.hasRemoteBin();
        if (!hay) {
          return;
        }

        if (typeof Android.getRemoteBinBase64 === "function") {
          const b64 = Android.getRemoteBinBase64();
          if (b64) {
            PREFETCH_BUF  = b64ToArrayBuffer(b64);
            PREFETCH_NAME = "autorizaciones.bin";

            fileLbl.textContent  = `Archivo (Drive): ${PREFETCH_NAME}`;
            stepPw.style.display = "flex";
            openBtn.disabled     = false;
            hideAlert();
            setAlert("ok", "Archivo de Autoriz. descargado desde Drive. Ingres√° la Contrase√±a.");
            pwInp.focus();
          }
        }
      } catch (e) {
        console.error(e);
      }
    }

    function applyFileIdInfo() {
      const id = window.FILE_ID_INFO;
      if (!id) return;
      if (!metaEl) return;

      const extra = ` ‚Ä¢ Fuente Drive: ${id}`;
      if (!metaEl.textContent.includes(extra)) {
        if (metaEl.textContent && !metaEl.textContent.endsWith(" ")) {
          metaEl.textContent += "";
        }
        metaEl.textContent += extra;
      }
    }

    window.setFileIdInfo = function (id) {
      window.FILE_ID_INFO = id;
      applyFileIdInfo();
    };

    modal.classList.remove("hidden");
    onRemoteReady();
    installEmojiFallbacks();
    setTimeout(hideSplash, 3200);
    applyFileIdInfo();
  </script>
</body>
</html>
